<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
    <script src="/uuid.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        socket.on('connect', () => {
            console.log("socket connected");
        });

        const uuid = new DeviceUUID().get();

        function getUrlParams() {     
            var params = {};  
            
            window.location.search.replace(/[?&]+([^=&]+)=([^&]*)/gi, 
                function(str, key, value) { 
                    params[key] = value; 
                }
            );     
            
            return params; 
        }

        function req(url, data, status) {
            const xhr = new XMLHttpRequest();
            xhr.open('POST', url);
            xhr.setRequestHeader('Content-Type', 'application/json');
            xhr.onreadystatechange = () => {
                if(xhr.readyState === 4 && xhr.status === 200) {
                    const data = JSON.parse(xhr.responseText);
                    switch(status) {
                        case 'o':
                            socket.emit('outing', data.socketData);
                            break;
                        case 'c':
                            socket.emit('comeback', data.socketData);
                            break;
                    }
                } else if(xhr.readyState === 4 && xhr.status === 500) {
                    // err 
                    window.parent.postMessage({ err:true, code:status }, '*');
                } else if(xhr.readyState === 4 && xhr.status === 400) {
                    const data = JSON.parse(xhr.responseText);
                    switch(data.code) {
                        case 'n':
                            req('/update', JSON.stringify({
                                field: decodeURI(q.field),
                                reason: decodeURI(q.reason),
                                uuid,
                                classNum: q.class
                            }), q.status);
                            break;
                        case 'a':
                            window.parent.postMessage({ err:true, code:'c' }, '*');
                            // alert('외출 상태가 아닙니다.\n복귀처리에 실패하였습니다.');
                            break;
                        case 'e':
                            window.parent.postMessage({ err:true, code:'r', serial: q.sid }, '*');
                            // alert('이미 회원가입 된 디바이스 입니다.');
                            break;
                        case 'd':
                            window.parent.postMessage({ err:true, code:q.field }, '*');
                            break;
                    }
                }
            }
            xhr.send(data);
        }

        const q = getUrlParams();
        socket.emit('class', q.class);
        switch(q.status) {
            case 'r':
                req('/register', JSON.stringify({
                    sid: q.sid,
                    number: decodeURI(q.number),
                    uuid,
                }), q.status);
                break;
            case 'o':
                req('/outing', JSON.stringify({
                    field: decodeURI(q.field),
                    reason: decodeURI(q.reason),
                    uuid,
                    classNum: q.class
                }), q.status);
                break;
            case 'c':
                req('/comeback', JSON.stringify({
                    uuid,
                    classNum: q.class
                }), q.status);
                break;
        }
    </script>
</body>
</html>