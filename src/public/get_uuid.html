<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
    <h3 id="title"></h3>
    <span id="exp"></span>
    <script src="/uuid.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        socket.on('connect', () => {
            console.log("socket connected");
        });

        const uuid = new DeviceUUID().get();

        function getUrlParams() {     
            var params = {};  
            
            window.location.search.replace(/[?&]+([^=&]+)=([^&]*)/gi, 
                function(str, key, value) { 
                    params[key] = value; 
                }
            );     
            
            return params; 
        }

        function req(url, data, status) {
            const xhr = new XMLHttpRequest();
            xhr.open('POST', url);
            xhr.setRequestHeader('Content-Type', 'application/json');
            xhr.onreadystatechange = () => {
                if(xhr.readyState === 4 && xhr.status === 200) {
                    alert("완료되었습니다");
                    const data = JSON.parse(xhr.responseText);
                    switch(status) {
                        case 'r':
                            document.getElementById("title").innerHTML = "회원가입이 완료되었습니다.";
                            break;
                        case 'o':
                            document.getElementById("title").innerHTML = "등록이 완료되었습니다.";
                            socket.emit('outing', data.socketData);
                            break;
                        case 'c':
                            document.getElementById("title").innerHTML = "복귀처리가 완료되었습니다.";
                            socket.emit('comeback', data.socketData);
                            break;
                        }
                    document.getElementById("exp").innerHTML = "이제 돌아가셔도 됩니다.";
                } else if(xhr.readyState === 4 && xhr.status === 500) {
                    alert("서버에서 오류가 발생하였습니다");
                } else if(xhr.readyState === 4 && xhr.status === 400) {
                    const data = JSON.parse(xhr.responseText);
                    switch(data.code) {
                        case 'n':
                            const a = confirm("이미 외출 상태 입니다.\n상태를 업데이트 하게습니까?");
                            if(a) {
                                req('/update', JSON.stringify({
                                    field: decodeURI(q.field),
                                    reason: decodeURI(q.reason),
                                    uuid,
                                    classNum: q.class
                                }), q.status);
                            }
                            break;
                        case 'a':
                            alert('외출 상태가 아닙니다.\n복귀처리에 실패하였습니다.');
                            break;
                        case 'e':
                            alert('이미 회원가입 된 디바이스 입니다.');
                            document.getElementById("title").innerHTML = "계정 삭제는 관리자에게 문의하세요";
                            break;
                    }
                }
            }
            xhr.send(data);
        }

        const q = getUrlParams();
        socket.emit('class', q.class);
        switch(q.status) {
            case 'r':
                req('/register', JSON.stringify({
                    sid: q.sid,
                    name: decodeURI(q.name),
                    uuid,
                }), q.status);
                break;
            case 'o':
                req('/outing', JSON.stringify({
                    field: decodeURI(q.field),
                    reason: decodeURI(q.reason),
                    uuid,
                    classNum: q.class
                }), q.status);
                break;
            case 'c':
                req('/comeback', JSON.stringify({
                    uuid,
                    classNum: q.class
                }), q.status);
                break;
            default:
                alert('에러가 발생하였습니다.');
                break;
        }
    </script>
</body>
</html>